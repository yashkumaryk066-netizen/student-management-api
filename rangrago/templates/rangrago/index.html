<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RangraGo - Premium Ride | Y.S.M AI</title>
    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <style>
        :root {
            --primary: #f59e0b;
            --dark: #0f172a;
            --glass: rgba(15, 23, 42, 0.85);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--dark);
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 0;
        }

        /* Premium Bottom Sheet */
        .bottom-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--glass);
            backdrop-filter: blur(25px);
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            padding: 24px;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
            transform: translateY(0);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Desktop specific override */
        @media (min-width: 768px) {
            .bottom-sheet {
                width: 400px;
                left: 20px;
                bottom: 20px;
                border-radius: 24px;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
        }

        /* Vehicle Selection Cards */
        .vehicle-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .vehicle-card.selected {
            background: rgba(245, 158, 11, 0.15);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.2);
        }

        /* Custom Map Marker Pulse */
        .gps-pulse {
            width: 20px;
            height: 20px;
            background: rgba(99, 102, 241, 0.5);
            border-radius: 50%;
            animation: pulse-animation 2s infinite;
        }

        @keyframes pulse-animation {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .hidden-sheet {
            transform: translateY(110%);
        }

        /* Input Styling */
        .nav-input-group {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 4px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
        }

        .nav-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 0 16px;
        }
    </style>
</head>

<body>

    <!-- Map Backend -->
    <div id="map"></div>

    <!-- Top Floating Bar (Menu & Profile) -->
    <div class="absolute top-4 left-4 right-4 z-[900] flex justify-between items-center pointer-events-none">
        <button onclick="window.history.back()"
            class="pointer-events-auto bg-slate-900/80 backdrop-blur-md w-10 h-10 rounded-full flex items-center justify-center text-white shadow-lg border border-white/10">
            <i class="fa-solid fa-arrow-left"></i>
        </button>
        <div
            class="pointer-events-auto bg-slate-900/80 backdrop-blur-md px-4 py-2 rounded-full flex items-center gap-2 shadow-lg border border-white/10">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span class="text-xs font-bold text-slate-300">RANGRAGO PRIME</span>
        </div>
        <div
            class="pointer-events-auto w-10 h-10 rounded-full bg-slate-900/80 backdrop-blur-md flex items-center justify-center border border-white/10 overflow-hidden">
            {% load static %}
            <img src="{% static 'images/yash_profile.jpg' %}" class="w-full h-full object-cover">
        </div>
    </div>

    <!-- Center Pin (Fixed) -->
    <div id="center-pin"
        class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[800] pointer-events-none flex flex-col items-center pb-[50px]">
        <div
            class="bg-black/80 backdrop-blur text-white text-[10px] px-3 py-1 rounded-full mb-2 border border-white/20 whitespace-nowrap shadow-xl">
            Set Pickup Location
        </div>
        <i class="fa-solid fa-location-dot text-4xl text-amber-500 drop-shadow-2xl filter brightness-110"
            style="filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));"></i>
        <div class="w-2 h-2 bg-black/50 rounded-full blur-[1px] mt-[-2px]"></div>
    </div>

    <!-- 1. Main Booking Sheet -->
    <div id="sheet-booking" class="bottom-sheet flex flex-col gap-5">
        <!-- Header -->
        <h2 class="text-xl font-bold flex items-center gap-2">
            <span class="text-amber-500">Where</span> to?
        </h2>

        <!-- Inputs -->
        <div class="nav-input-group">
            <!-- Pickup (Auto-filled) -->
            <div class="nav-item">
                <div class="w-6 flex justify-center mr-3">
                    <div class="w-3 h-3 rounded-full bg-green-500 border-2 border-slate-900"></div>
                </div>
                <input type="text" id="pickup-display" readonly value="Detecting location..."
                    class="bg-transparent w-full text-sm font-medium focus:outline-none text-slate-300 truncate">
            </div>

            <div class="nav-divider"></div>

            <!-- Drop -->
            <div class="nav-item">
                <div class="w-6 flex justify-center mr-3">
                    <div class="w-3 h-3 rounded-sm bg-red-500 border-2 border-slate-900"></div>
                </div>
                <input type="text" id="drop-input" placeholder="Search destination (e.g. Station)"
                    class="bg-transparent w-full text-base font-bold focus:outline-none text-white placeholder-slate-500">
            </div>
        </div>

        <!-- Vehicle Selection -->
        <div class="grid grid-cols-3 gap-3">
            <!-- Bike -->
            <div class="vehicle-card selected p-3 flex flex-col items-center cursor-pointer relative"
                onclick="selectVehicle(this, 'BIKE')">
                <span class="absolute top-1 right-2 text-[10px] font-bold text-green-400">FASTEST</span>
                <i class="fa-solid fa-motorcycle text-3xl mb-2 text-slate-200"></i>
                <div class="text-sm font-bold">Bike</div>
                <div class="text-xs text-slate-400">₹35</div>
            </div>
            <!-- Auto -->
            <div class="vehicle-card p-3 flex flex-col items-center cursor-pointer"
                onclick="selectVehicle(this, 'AUTO')">
                <i class="fa-solid fa-truck-pickup text-3xl mb-2 text-slate-200"></i>
                <div class="text-sm font-bold">Auto</div>
                <div class="text-xs text-slate-400">₹55</div>
            </div>
            <!-- Car -->
            <div class="vehicle-card p-3 flex flex-col items-center cursor-pointer"
                onclick="selectVehicle(this, 'SEDAN')">
                <i class="fa-solid fa-car text-3xl mb-2 text-slate-200"></i>
                <div class="text-sm font-bold">Prime</div>
                <div class="text-xs text-slate-400">₹120</div>
            </div>
        </div>

        <!-- Action Button -->
        <button onclick="bookRide()"
            class="w-full bg-amber-500 hover:bg-amber-400 text-black font-bold text-lg py-4 rounded-xl shadow-lg shadow-amber-500/25 transition-all active:scale-95 flex items-center justify-center gap-3">
            <span>Book RangraGo</span>
            <i class="fa-solid fa-arrow-right"></i>
        </button>
    </div>

    <!-- 2. Searching Sheet (Hidden) -->
    <div id="sheet-searching"
        class="bottom-sheet hidden-sheet flex flex-col items-center justify-center text-center py-10">
        <div class="relative w-24 h-24 mb-6">
            <div class="absolute inset-0 border-4 border-slate-700 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-amber-500 rounded-full border-t-transparent animate-spin">
            </div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fa-solid fa-search text-2xl text-slate-500"></i>
            </div>
        </div>
        <h3 class="text-2xl font-bold mb-2">Connecting nearby Pilots...</h3>
        <p class="text-slate-400 text-sm mb-8">We are contacting the nearest drivers for you.</p>
        <button onclick="cancelSearch()"
            class="px-8 py-3 rounded-full border border-red-500/50 text-red-400 font-semibold hover:bg-red-500/10">
            Cancel Request
        </button>
    </div>

    <!-- 3. Driver Found Sheet (Hidden) -->
    <div id="sheet-found" class="bottom-sheet hidden-sheet">
        <div class="flex items-center gap-4 mb-6">
            <div class="bg-green-500/20 text-green-500 p-3 rounded-full">
                <i class="fa-solid fa-check text-xl"></i>
            </div>
            <div>
                <h3 class="text-lg font-bold">Driver is arriving!</h3>
                <p class="text-xs text-slate-400">2 mins away</p>
            </div>
        </div>

        <!-- Driver Card -->
        <div class="bg-slate-800/50 rounded-xl p-4 border border-white/5 flex gap-4 items-center mb-6">
            <div class="w-14 h-14 rounded-full bg-slate-700 overflow-hidden">
                <img src="https://ui-avatars.com/api/?name=Driver&background=random" class="w-full h-full"
                    id="driver-img">
            </div>
            <div class="flex-1">
                <h4 class="font-bold text-lg" id="driver-name">Loading...</h4>
                <div class="text-sm text-slate-400 flex items-center gap-2">
                    <i class="fa-solid fa-star text-amber-500 text-xs"></i> 4.8 Rating
                </div>
            </div>
            <div class="text-right">
                <div class="font-mono font-bold text-xl text-white" id="vehicle-number">BR-10-XX</div>
                <div class="text-xs text-slate-500 uppercase" id="vehicle-model">Bike</div>
            </div>
        </div>

        <!-- OTP Box -->
        <div class="bg-amber-500 text-black rounded-xl p-4 text-center">
            <div class="text-xs font-bold uppercase opacity-60 mb-1">Share OTP with Pilot</div>
            <div class="text-4xl font-mono font-black tracking-[0.2em]" id="otp-display">----</div>
        </div>
    </div>


    <script>
        // --- 1. Map Initialization (Premium Dark Theme) ---
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([25.26, 87.01], 16);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 20
        }).addTo(map);

        // --- 2. Live Fake Cars Feature ---
        const carIcon = L.divIcon({
            className: 'fake-car',
            html: '<i class="fa-solid fa-car-side text-amber-500 text-lg" style="transform: rotate(45deg); filter: drop-shadow(0 0 5px rgba(245,158,11,0.5));"></i>',
            iconSize: [20, 20]
        });

        function spawnFakeCars() {
            const center = map.getCenter();
            for (let i = 0; i < 4; i++) {
                const latDiff = (Math.random() - 0.5) * 0.01;
                const lngDiff = (Math.random() - 0.5) * 0.01;
                L.marker([center.lat + latDiff, center.lng + lngDiff], { icon: carIcon }).addTo(map);
            }
        }
        setTimeout(spawnFakeCars, 2000);


        // --- 3. Reverse Geocoding Logic ---
        async function updateAddress() {
            const center = map.getCenter();
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}`;

            try {
                // Throttle requests in real app
                const res = await fetch(url);
                const data = await res.json();
                const address = data.display_name.split(',')[0] + ", " + data.display_name.split(',')[1];
                document.getElementById('pickup-display').value = address;
            } catch (e) {
                document.getElementById('pickup-display').value = \`Lat: \${center.lat.toFixed(4)}, Lng: \${center.lng.toFixed(4)}\`;
            }
        }
        
        let debounceTimer;
        map.on('moveend', () => {
            clearTimeout(debounceTimer);
            document.getElementById('pickup-display').value = "Loading location...";
            debounceTimer = setTimeout(updateAddress, 1000);
        });


        // --- 4. Booking Logic ---
        
        function selectVehicle(el, type) {
            document.querySelectorAll('.vehicle-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        let pollInterval;
        let currentRideId;

        async function bookRide() {
            const drop = document.getElementById('drop-input').value;
            if(!drop) {
                alert("Please enter destination");
                return;
            }

            // UI: Switch to Searching
            document.getElementById('sheet-booking').classList.add('hidden-sheet');
            document.getElementById('sheet-searching').classList.remove('hidden-sheet');

            const center = map.getCenter();
            
            // API Call
            const formData = new FormData();
            formData.append('pickup', document.getElementById('pickup-display').value);
            formData.append('drop', drop);
            formData.append('lat', center.lat);
            formData.append('lng', center.lng);

            try {
                const res = await fetch('/rangrago/api/book/', { method:'POST', body: formData });
                const data = await res.json();
                if(data.success) {
                    currentRideId = data.ride_id;
                    pollInterval = setInterval(checkStatus, 3000);
                } else {
                    alert("Error: " + data.error);
                    cancelSearch();
                }
            } catch(e) {
                alert("Connection failed");
                cancelSearch();
            }
        }

        async function checkStatus() {
            if(!currentRideId) return;
            const res = await fetch(\`/rangrago/api/status/\${currentRideId}/\`);
            const data = await res.json();
            
            if(data.status === 'ACCEPTED') {
                clearInterval(pollInterval);
                showDriverFound(data);
            }
        }

        function showDriverFound(data) {
            document.getElementById('sheet-searching').classList.add('hidden-sheet');
            document.getElementById('sheet-found').classList.remove('hidden-sheet');
            
            document.getElementById('driver-name').innerText = data.driver_name;
            document.getElementById('vehicle-number').innerText = data.vehicle.split('|')[1] || data.vehicle;
            document.getElementById('vehicle-model').innerText = data.vehicle.split('|')[0] || 'Vehicle';
            document.getElementById('otp-display').innerText = data.otp;
        }

        function cancelSearch() {
            clearInterval(pollInterval);
            document.getElementById('sheet-searching').classList.add('hidden-sheet');
            document.getElementById('sheet-booking').classList.remove('hidden-sheet');
        }

        // Init
        setTimeout(updateAddress, 1000);

    </script>
</body>

</html>